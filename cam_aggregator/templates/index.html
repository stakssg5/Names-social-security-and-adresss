{% extends "base.html" %}
{% block content %}
<section>
  <h1>Find Public Webcams</h1>
  <form id="search-form" onsubmit="return false;" class="search-form">
    <input type="text" id="q" name="q" placeholder="Search by agency, city, or camera" autofocus />
    <select id="agency">
      <option value="">All agencies</option>
    </select>
    <select id="tag">
      <option value="">All tags</option>
    </select>
    <select id="stream_type">
      <option value="">All types</option>
      <option value="hls">HLS</option>
      <option value="mjpeg">MJPEG</option>
      <option value="image">Image</option>
      <option value="iframe">IFrame</option>
    </select>
    <input type="number" id="page" min="1" value="1" style="width:80px" />
    <button type="button" onclick="runSearch()">Search</button>
  </form>
  <div id="results" class="results"></div>
</section>
<script>
async function runSearch() {
  const q = document.getElementById('q').value.trim();
  const agency = document.getElementById('agency').value;
  const tag = document.getElementById('tag').value;
  const streamType = document.getElementById('stream_type').value;
  const page = parseInt(document.getElementById('page').value || '1', 10);

  const params = new URLSearchParams();
  if (q) params.set('q', q);
  if (agency) params.set('agency', agency);
  if (tag) params.set('tag', tag);
  if (streamType) params.set('stream_type', streamType);
  if (page > 1) params.set('page', String(page));

  const url = `/api/cameras${params.toString() ? '?' + params.toString() : ''}`;
  const res = await fetch(url);
  const data = await res.json();
  const results = document.getElementById('results');
  if (!Array.isArray(data) || data.length === 0) {
    results.innerHTML = '<p>No cameras found.</p>';
    return;
  }
  results.innerHTML = data.map(c => `
    <a class="card" href="/cameras/${c.id}">
      <div class="card-body">
        <div class="card-title">${escapeHtml(c.name)}</div>
        <div class="card-sub">${escapeHtml(c.agency.name)}${c.location ? ' — ' + escapeHtml(c.location) : ''}</div>
        <div class="card-meta">Type: ${escapeHtml(c.stream_type.toUpperCase())}${(c.tags && c.tags.length) ? ' · ' + c.tags.map(t => '#' + escapeHtml(t)).join(' ') : ''}</div>
      </div>
    </a>
  `).join('');
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

async function initFilters() {
  // Agencies
  try {
    const resA = await fetch('/api/agencies');
    const agencies = await resA.json();
    const sel = document.getElementById('agency');
    agencies.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.slug; opt.textContent = `${a.name} (${a.camera_count})`;
      sel.appendChild(opt);
    });
  } catch {}
  // Tags
  try {
    const resT = await fetch('/api/tags');
    const tags = await resT.json();
    const selT = document.getElementById('tag');
    tags.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name; opt.textContent = `${t.name} (${t.camera_count})`;
      selT.appendChild(opt);
    });
  } catch {}
}

// Auto-run on load
initFilters().then(runSearch);
</script>
{% endblock %}
